<!DOCTYPE html>
<!-- Admin dashboard template for user management and system administration -->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Meta tags for responsive design and character encoding -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vehicle Service System</title>
    <!-- External CSS libraries for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS for dashboard styling -->
    <link href="/css/dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <i class="fas fa-car"></i>
                Vehicle Service
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/logout" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-area">
            <!-- Page Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">Admin Dashboard</h1>
                        <p class="page-subtitle">Manage users and monitor system activity</p>
                    </div>
                    <div class="user-profile">
                        <div class="avatar" th:text="${#authentication != null ? #authentication.name.substring(0,2).toUpperCase() : 'AD'}">AD</div>
                        <div>
                            <div class="fw-semibold" th:text="${#authentication != null ? #authentication.name : 'Admin User'}">Admin User</div>
                            <small class="text-muted">System Administrator</small>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Success/Error Messages -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close alert"></button>
        </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" th:text="${totalUsers}">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-number" th:text="${adminUsers}">0</div>
                    <div class="stat-label">Admin Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-number" th:text="${staffUsers}">0</div>
                    <div class="stat-label">Staff Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="stat-number" th:text="${customerUsers}">0</div>
                    <div class="stat-label">Customers</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card" data-bs-toggle="modal" data-bs-target="#userModal">
                    <i class="fas fa-user-plus"></i>
                    <h5>Add User</h5>
                    <p>Register new user</p>
                </div>
                <div class="action-card" onclick="toggleUserManagement()">
                    <i class="fas fa-users-cog"></i>
                    <h5>Manage Users</h5>
                    <p>View all users</p>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="card mb-3" id="user-management">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users-cog me-2"></i>
                            User Management
                        </h5>
                    <div class="d-flex align-items-center gap-2">
                        <form method="get" action="/admin/dashboard" class="d-flex align-items-center gap-2" id="filterForm">
                            <input type="hidden" name="page" value="0" id="pageInput">
                            <input type="hidden" name="size" th:value="${size}" id="sizeInput">
                            
                            <div class="position-relative">
                                <label for="userSearchInput" class="visually-hidden">Search users</label>
                                <input type="text" class="form-control form-control-sm search-input" id="userSearchInput" 
                                       name="search" th:value="${search}" placeholder="Search users..." 
                                       autocomplete="off" aria-label="Search users">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            
                            <label for="roleFilter" class="visually-hidden">Filter by role</label>
                            <select class="form-select form-select-sm role-filter" id="roleFilter" name="role" aria-label="Filter by role">
                                <option value="">All Roles</option>
                                <option value="ADMIN" th:selected="${role == 'ADMIN'}">Admin</option>
                                <option value="MANAGER" th:selected="${role == 'MANAGER'}">Manager</option>
                                <option value="RECEPTIONIST" th:selected="${role == 'RECEPTIONIST'}">Receptionist</option>
                                <option value="TECHNICIAN" th:selected="${role == 'TECHNICIAN'}">Technician</option>
                                <option value="INVENTORY_MANAGER" th:selected="${role == 'INVENTORY_MANAGER'}">Inventory Manager</option>
                                <option value="CUSTOMER" th:selected="${role == 'CUSTOMER'}">Customer</option>
                            </select>
                            
                            <label for="statusFilter" class="visually-hidden">Filter by status</label>
                            <select class="form-select form-select-sm status-filter" id="statusFilter" name="status" aria-label="Filter by status">
                                <option value="">All Status</option>
                                <option value="active" th:selected="${status == 'active'}">Active</option>
                                <option value="inactive" th:selected="${status == 'inactive'}">Inactive</option>
                            </select>
                            
                            <label for="pageSizeFilter" class="visually-hidden">Page size</label>
                            <select class="form-select form-select-sm page-size-filter" id="pageSizeFilter" name="size" aria-label="Page size">
                                <option value="5" th:selected="${size == 5}">5</option>
                                <option value="10" th:selected="${size == 10}">10</option>
                                <option value="25" th:selected="${size == 25}">25</option>
                                <option value="50" th:selected="${size == 50}">50</option>
                            </select>
                            
                            <button type="submit" class="btn btn-primary btn-sm" title="Apply filters">
                                <i class="fas fa-search"></i>
                            </button>
                            
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn" title="Clear all filters">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                                    </div>
                                </div>
            </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>USER</th>
                                    <th>EMAIL</th>
                                    <th>ROLE</th>
                                    <th>STATUS</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${#lists.isEmpty(allUsers)}">
                                    <td colspan="5" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-search fa-2x"></i>
                                            <h5>No users found</h5>
                                            <p>No users found matching your criteria. Try adjusting your search or filter settings.</p>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:each="user : ${allUsers}" th:attr="data-user-id=${user.id}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2 small-avatar" 
                                                 th:text="${user.firstName.substring(0,1) + user.lastName.substring(0,1)}">JD</div>
                                            <div>
                                                <div class="fw-semibold" th:text="${user.firstName + ' ' + user.lastName}">John Doe</div>
                                                <small class="text-muted" th:text="${user.username}">john_doe</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td th:text="${user.email}">john@example.com</td>
                                    <td>
                                        <span class="status-badge" th:classappend="${user.role.roleName == 'ADMIN'} ? 'status-pending' : 
                                                                                   (${user.role.roleName == 'RECEPTIONIST'} ? 'status-confirmed' : 'status-completed')" 
                                              th:text="${user.role.roleName}">CUSTOMER</span>
                                    </td>
                                    <td>
                                        <span class="status-badge" th:classappend="${user.isActive} ? 'status-confirmed' : 'status-pending'"
                                              th:text="${user.isActive} ? 'Active' : 'Inactive'">Active</span>
                                    </td>
                                    <td>
                                        <button class="btn-action" title="View" th:onclick="'viewUser(' + ${user.id} + ')'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn-action" title="Edit" th:onclick="'editUser(' + ${user.id} + ')'">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-action" title="Delete" th:onclick="'deleteUser(' + ${user.id} + ')'">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                    
                <!-- Pagination Controls -->
                <div class="card-footer" th:if="${totalPages > 1}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            Showing <span th:text="${currentPage * size + 1}">1</span> to 
                            <span th:text="${(currentPage + 1) * size > totalElements ? totalElements : (currentPage + 1) * size}">5</span> of 
                            <span th:text="${totalElements}">10</span> users
                            <span th:if="${totalPages > 1}">
                                | Page <span th:text="${currentPage + 1}">1</span> of <span th:text="${totalPages}">1</span>
                            </span>
                        </div>
                        <nav aria-label="User pagination">
                            <ul class="pagination pagination-sm mb-0">
                                <!-- Previous Button -->
                                <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/dashboard(page=${currentPage - 1}, size=${size}, search=${search}, role=${role}, status=${status})}" 
                                       th:if="${hasPrevious}">
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </a>
                                    <span class="page-link" th:unless="${hasPrevious}">
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </span>
                                </li>
                                
                                <!-- Page Numbers -->
                                <li th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, currentPage - 2), T(java.lang.Math).min(totalPages - 1, currentPage + 2))}" 
                                    class="page-item" 
                                    th:classappend="${pageNum == currentPage} ? 'active'">
                                    <a class="page-link" 
                                       th:href="@{/admin/dashboard(page=${pageNum}, size=${size}, search=${search}, role=${role}, status=${status})}"
                                       th:text="${pageNum + 1}">1</a>
                                </li>
                                
                                <!-- Next Button -->
                                <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/dashboard(page=${currentPage + 1}, size=${size}, search=${search}, role=${role}, status=${status})}" 
                                       th:if="${hasNext}">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <span class="page-link" th:unless="${hasNext}">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">
                        <i class="fas fa-user-plus me-2"></i>Add New User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/admin/users}" method="post" id="userForm" novalidate>
                    <div class="modal-body">
                        <!-- Loading indicator -->
                        <div id="formLoading" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Processing your request...</p>
                        </div>
                        
                        <!-- Form content -->
                        <div id="formContent">
                            <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-user me-2 text-primary"></i>First Name *
                                </label>
                                <input type="text" class="form-control" id="firstName" name="firstName" 
                                       placeholder="Enter first name (letters only)" required 
                                       minlength="2" maxlength="50" 
                                       pattern="[A-Za-z\s'-]+" 
                                       title="Please enter a valid first name (letters, spaces, hyphens, and apostrophes only)"
                                       onkeypress="return /[A-Za-z\s'-]/.test(event.key)">
                                <div class="invalid-feedback" id="firstNameError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-user me-2 text-primary"></i>Last Name *
                                </label>
                                <input type="text" class="form-control" id="lastName" name="lastName" 
                                       placeholder="Enter last name (letters only)" required 
                                       minlength="2" maxlength="50" 
                                       pattern="[A-Za-z\s'-]+" 
                                       title="Please enter a valid last name (letters, spaces, hyphens, and apostrophes only)"
                                       onkeypress="return /[A-Za-z\s'-]/.test(event.key)">
                                <div class="invalid-feedback" id="lastNameError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-at me-2 text-primary"></i>Username *
                                </label>
                                <input type="text" class="form-control" id="username" name="username" 
                                       placeholder="Enter username (letters, numbers, underscores)" required 
                                       minlength="3" maxlength="20" 
                                       pattern="[A-Za-z0-9_]+" 
                                       title="Username must be 3-20 characters (letters, numbers, and underscores only)">
                                <div class="invalid-feedback" id="usernameError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-envelope me-2 text-primary"></i>Email *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       placeholder="Enter email address (e.g., user@example.com)" required 
                                       maxlength="100" 
                                       title="Please enter a valid email address">
                                <div class="invalid-feedback" id="emailError"></div>
                            </div>
                            </div>
                            <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-lock me-2 text-primary"></i>Password *
                                </label>
                                <div class="position-relative">
                                    <input type="password" class="form-control pe-5" id="password" name="password" 
                                           placeholder="Enter password (min 8 chars, uppercase, lowercase, number)" required 
                                           minlength="8" maxlength="50" 
                                       pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$" 
                                           title="Password must be at least 8 characters with uppercase, lowercase, and number">
                                    <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 password-toggle-btn" type="button" id="togglePassword" onclick="togglePasswordVisibility()" aria-label="Toggle password visibility">
                                        <i class="fas fa-eye" id="passwordToggleIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback" id="passwordError"></div>
                                </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-user-tag me-2 text-primary"></i>Role *
                                </label>
                                <select class="form-select" id="role" name="roleId" required>
                                    <option value="">Select a role</option>
                                    <option th:each="role : ${roles}" th:if="${role.roleName != 'CUSTOMER'}" th:value="${role.id}" th:text="${role.roleName}">ADMIN</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">+94</span>
                                <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" 
                                           placeholder="Enter 9-digit phone number (e.g., 712345678)" 
                                           pattern="[0-9]{9}" 
                                           maxlength="9" 
                                           minlength="9"
                                           title="Please enter a valid 9-digit Sri Lankan phone number"
                                           onkeypress="return /[0-9]/.test(event.key)">
                                </div>
                                <div class="invalid-feedback" id="phoneNumberError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-2 text-primary"></i>Date of Birth
                                </label>
                                <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" 
                                       max="2010-12-31" 
                                       title="Date of birth must be before 2011">
                                <div class="invalid-feedback" id="dateOfBirthError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-map-marker-alt me-2 text-primary"></i>Address
                                </label>
                                <input type="text" class="form-control" id="address" name="address" 
                                       placeholder="Enter full address (street, city, state)" 
                                       maxlength="200" 
                                       pattern="[A-Za-z0-9\s,./-]{5,200}" 
                                       title="Enter the user's full address (letters, numbers, spaces, commas, periods, slashes, and hyphens allowed)">
                                <div class="invalid-feedback" id="addressError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-city me-2 text-primary"></i>City
                                </label>
                                <input type="text" class="form-control" id="city" name="city" 
                                       placeholder="Enter city name (letters only)" 
                                       maxlength="50" 
                                       pattern="[A-Za-z\s]+" 
                                       title="Please enter a valid city name"
                                       onkeypress="return /[A-Za-z\s]/.test(event.key)">
                                <div class="invalid-feedback" id="cityError"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-map me-2 text-primary"></i>State
                                </label>
                                <input type="text" class="form-control" id="state" name="state" 
                                       placeholder="Enter state name (letters only)" 
                                       maxlength="50" 
                                       pattern="[A-Za-z\s]+" 
                                       title="Please enter a valid state name"
                                       onkeypress="return /[A-Za-z\s]/.test(event.key)">
                                <div class="invalid-feedback" id="stateError"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-mail-bulk me-2 text-primary"></i>ZIP Code
                                </label>
                                <input type="text" class="form-control" id="zipCode" name="zipCode" 
                                       placeholder="Enter ZIP/postal code" 
                                       maxlength="10" 
                                       title="Please enter a valid ZIP/postal code">
                                <div class="invalid-feedback" id="zipCodeError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-2 text-primary"></i>Status
                                </label>
                                <select class="form-select" id="isActive" name="isActive">
                                    <option value="true" selected>Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        </div>
                        </div> <!-- End formContent -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View User Modal -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewUserModalLabel">
                        <i class="fas fa-user me-2"></i>User Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewUserContent">
                    <!-- User details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">
                        <i class="fas fa-user-edit me-2"></i>Edit User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm" method="post" novalidate>
                    <div class="modal-body">
                        <!-- Loading indicator -->
                        <div id="editFormLoading" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Updating user...</p>
                        </div>
                        
                        <!-- Form content -->
                        <div id="editFormContent">
                            <input type="hidden" id="editUserId" name="id">
                        
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-user me-2 text-primary"></i>First Name *
                                </label>
                                <input type="text" class="form-control" id="editFirstName" name="firstName" 
                                       placeholder="Enter first name (letters only)" required 
                                       minlength="2" maxlength="50" 
                                       pattern="[A-Za-z\s'-]+" 
                                       title="Please enter a valid first name (letters, spaces, hyphens, and apostrophes only)"
                                       onkeypress="return /[A-Za-z\s'-]/.test(event.key)">
                                <div class="invalid-feedback" id="editFirstNameError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-user me-2 text-primary"></i>Last Name *
                                </label>
                                <input type="text" class="form-control" id="editLastName" name="lastName" 
                                       placeholder="Enter last name (letters only)" required 
                                       minlength="2" maxlength="50" 
                                       pattern="[A-Za-z\s'-]+" 
                                       title="Please enter a valid last name (letters, spaces, hyphens, and apostrophes only)"
                                       onkeypress="return /[A-Za-z\s'-]/.test(event.key)">
                                <div class="invalid-feedback" id="editLastNameError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-at me-2 text-primary"></i>Username *
                                </label>
                                <input type="text" class="form-control" id="editUsername" name="username" 
                                       placeholder="Enter username (letters, numbers, underscores)" required 
                                       minlength="3" maxlength="20" 
                                       pattern="[A-Za-z0-9_]+" 
                                       title="Username must be 3-20 characters (letters, numbers, and underscores only)">
                                <div class="invalid-feedback" id="editUsernameError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-envelope me-2 text-primary"></i>Email *
                                </label>
                                <input type="email" class="form-control" id="editEmail" name="email" 
                                       placeholder="Enter email address (e.g., user@example.com)" required 
                                       maxlength="100" 
                                       title="Please enter a valid email address">
                                <div class="invalid-feedback" id="editEmailError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-user-tag me-2 text-primary"></i>Role *
                                </label>
                                <select class="form-select" id="editRole" name="roleId" required>
                                    <option value="">Select a role</option>
                                    <option th:each="role : ${roles}" th:if="${role.roleName != 'CUSTOMER'}" th:value="${role.id}" th:text="${role.roleName}">ADMIN</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-2 text-primary"></i>Status
                                </label>
                                <select class="form-select" id="editIsActive" name="isActive">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-lock me-2 text-primary"></i>New Password (Optional)
                                </label>
                                <div class="position-relative">
                                    <input type="password" class="form-control pe-5" id="editPassword" name="password" 
                                           placeholder="Leave blank to keep current password" 
                                           minlength="8" maxlength="50" 
                                           pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$" 
                                           title="Password must be at least 8 characters with uppercase, lowercase, and number">
                                    <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 password-toggle-btn" type="button" id="toggleEditPassword" onclick="toggleEditPasswordVisibility()" aria-label="Toggle password visibility">
                                        <i class="fas fa-eye" id="editPasswordToggleIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback" id="editPasswordError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>Password Note
                                </label>
                                <div class="form-control-plaintext text-muted small">
                                    Leave password field empty to keep the current password unchanged
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">+94</span>
                                <input type="tel" class="form-control" id="editPhoneNumber" name="phoneNumber" 
                                           placeholder="Enter 9-digit phone number (e.g., 712345678)" 
                                           pattern="[0-9]{9}" 
                                           maxlength="9" 
                                           minlength="9"
                                           title="Please enter a valid 9-digit Sri Lankan phone number"
                                           onkeypress="return /[0-9]/.test(event.key)">
                                </div>
                                <div class="invalid-feedback" id="editPhoneNumberError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-2 text-primary"></i>Date of Birth
                                </label>
                                <input type="date" class="form-control" id="editDateOfBirth" name="dateOfBirth" 
                                       max="2010-12-31" 
                                       title="Date of birth must be before 2011">
                                <div class="invalid-feedback" id="editDateOfBirthError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-map-marker-alt me-2 text-primary"></i>Address
                                </label>
                                <input type="text" class="form-control" id="editAddress" name="address" 
                                       placeholder="Enter full address (street, city, state)" 
                                       maxlength="200" 
                                       pattern="[A-Za-z0-9\s,./-]{5,200}" 
                                       title="Enter the user's full address (letters, numbers, spaces, commas, periods, slashes, and hyphens allowed)">
                                <div class="invalid-feedback" id="editAddressError"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-city me-2 text-primary"></i>City
                                </label>
                                <input type="text" class="form-control" id="editCity" name="city" 
                                       placeholder="Enter city name (letters only)" 
                                       maxlength="50" 
                                       pattern="[A-Za-z\s]+" 
                                       title="Please enter a valid city name"
                                       onkeypress="return /[A-Za-z\s]/.test(event.key)">
                                <div class="invalid-feedback" id="editCityError"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-map me-2 text-primary"></i>State
                                </label>
                                <input type="text" class="form-control" id="editState" name="state" 
                                       placeholder="Enter state name (letters only)" 
                                       maxlength="50" 
                                       pattern="[A-Za-z\s]+" 
                                       title="Please enter a valid state name"
                                       onkeypress="return /[A-Za-z\s]/.test(event.key)">
                                <div class="invalid-feedback" id="editStateError"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">
                                    <i class="fas fa-mail-bulk me-2 text-primary"></i>ZIP Code
                                </label>
                                <input type="text" class="form-control" id="editZipCode" name="zipCode" 
                                       placeholder="Enter ZIP/postal code" 
                                       maxlength="10" 
                                       title="Please enter a valid ZIP/postal code">
                                <div class="invalid-feedback" id="editZipCodeError"></div>
                            </div>
                        </div>
                        </div> <!-- End editFormContent -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle user management section
        function toggleUserManagement() {
            const userManagement = document.getElementById('user-management');
            if (userManagement.style.display === 'none') {
                userManagement.style.display = 'block';
                userManagement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                userManagement.style.display = 'none';
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordField = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Toggle edit password visibility
        function toggleEditPasswordVisibility() {
            const passwordField = document.getElementById('editPassword');
            const toggleIcon = document.getElementById('editPasswordToggleIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // User management functions
        function viewUser(userId) {
            // Fetch complete user data from API
            fetch(`/admin/api/users/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch user data');
                    }
                    return response.json();
                })
                .then(user => {
                    // Helper functions for formatting
                    const formatDate = (dateString) => {
                        if (!dateString) return 'N/A';
                        return new Date(dateString).toLocaleDateString();
                    };

                    const formatDateTime = (dateString) => {
                        if (!dateString) return 'N/A';
                        return new Date(dateString).toLocaleString();
                    };

                    const getStatusBadgeClass = (isActive) => {
                        return isActive ? 'bg-success' : 'bg-secondary';
                    };

                    const getRoleBadgeClass = (roleName) => {
                        switch(roleName) {
                            case 'ADMIN': return 'bg-danger';
                            case 'MANAGER': return 'bg-warning';
                            case 'RECEPTIONIST': return 'bg-info';
                            case 'TECHNICIAN': return 'bg-primary';
                            case 'FUEL_STAFF': return 'bg-success';
                            case 'INVENTORY_MANAGER': return 'bg-dark';
                            case 'CUSTOMER': return 'bg-secondary';
                            default: return 'bg-primary';
                        }
                    };

                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                    const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                    const role = user.role ? user.role.roleName : 'N/A';
                    const status = user.isActive ? 'Active' : 'Inactive';

                    // Populate the view modal with compact structure like receptionist dashboard
                    document.getElementById('viewUserContent').innerHTML = `
                        <!-- User Header -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <h6 class="text-muted mb-1">User Information</h6>
                                <h5 class="mb-0">${fullName || 'N/A'}</h5>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${getStatusBadgeClass(user.isActive)} me-2">
                                    ${status}
                                </span>
                                <span class="badge ${getRoleBadgeClass(role)}">
                                    ${role}
                                </span>
                            </div>
                        </div>

                        <!-- Personal & Account Details -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Personal Details</h6>
                                        ${user.firstName ? `<div class="mb-2"><strong>First Name:</strong> ${user.firstName}</div>` : ''}
                                        ${user.lastName ? `<div class="mb-2"><strong>Last Name:</strong> ${user.lastName}</div>` : ''}
                                        ${user.email ? `<div class="mb-2"><strong>Email:</strong> ${user.email}</div>` : ''}
                                        ${user.phoneNumber ? `<div class="mb-0"><strong>Phone:</strong> ${user.phoneNumber}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Account Details</h6>
                                        ${user.username ? `<div class="mb-2"><strong>Username:</strong> ${user.username}</div>` : ''}
                                        ${user.dateOfBirth ? `<div class="mb-2"><strong>Date of Birth:</strong> ${formatDate(user.dateOfBirth)}</div>` : ''}
                                        ${user.createdAt ? `<div class="mb-2"><strong>Member Since:</strong> ${formatDate(user.createdAt)}</div>` : ''}
                                        ${user.lastLogin ? `<div class="mb-0"><strong>Last Login:</strong> ${formatDateTime(user.lastLogin)}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Address Information -->
                        ${(user.address || user.city || user.state || user.zipCode) ? `
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Address Information</h6>
                                        <div class="row">
                                            ${user.address ? `<div class="col-md-6 mb-2"><strong>Address:</strong> ${user.address}</div>` : ''}
                                            ${user.city ? `<div class="col-md-3 mb-2"><strong>City:</strong> ${user.city}</div>` : ''}
                                            ${user.state ? `<div class="col-md-3 mb-2"><strong>State:</strong> ${user.state}</div>` : ''}
                                            ${user.zipCode ? `<div class="col-md-3 mb-0"><strong>ZIP Code:</strong> ${user.zipCode}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Additional Info -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Account Summary</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="text-center p-2 border rounded">
                                                    <div class="text-muted small">User ID</div>
                                                    <div class="h6 mb-0">${user.id || 'N/A'}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="text-center p-2 border rounded">
                                                    <div class="text-muted small">Role</div>
                                                    <div class="h6 mb-0">
                                                        <span class="badge ${getRoleBadgeClass(role)}">${role}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;


                    // Show the modal
                    const viewModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                    viewModal.show();
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    document.getElementById('viewUserContent').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> Could not load user details. ${error.message}
                        </div>
                    `;
                    const viewModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                    viewModal.show();
                });
        }

        function editUser(userId) {
            // Show loading state
            showFormLoading('editUserForm');
            
            // Fetch complete user data from API
            fetch(`/admin/api/users/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch user data');
                    }
                    return response.json();
                })
                .then(user => {
                    // Hide loading state
                    hideFormLoading('editUserForm');
                    
                    // Populate the edit form with complete user data
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editFirstName').value = user.firstName || '';
                    document.getElementById('editLastName').value = user.lastName || '';
                    document.getElementById('editUsername').value = user.username || '';
                    document.getElementById('editEmail').value = user.email || '';
                    
                    // Clear password field (don't populate it for security reasons)
                    document.getElementById('editPassword').value = '';
                    
                    document.getElementById('editPhoneNumber').value = user.phoneNumber || '';
                    document.getElementById('editAddress').value = user.address || '';
                    document.getElementById('editCity').value = user.city || '';
                    document.getElementById('editState').value = user.state || '';
                    document.getElementById('editZipCode').value = user.zipCode || '';
                    
                    // Set date of birth (convert from ISO string to YYYY-MM-DD format)
                    if (user.dateOfBirth) {
                        const date = new Date(user.dateOfBirth);
                        const formattedDate = date.toISOString().split('T')[0];
                        document.getElementById('editDateOfBirth').value = formattedDate;
                    } else {
                        document.getElementById('editDateOfBirth').value = '';
                    }
                    
                    // Set role
                    const roleSelect = document.getElementById('editRole');
                    if (roleSelect && user.role) {
                        // Find the option that matches the user's role ID
                        for (let i = 0; i < roleSelect.options.length; i++) {
                            if (roleSelect.options[i].value == user.role.id) {
                                roleSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    // Set status
                    const statusSelect = document.getElementById('editIsActive');
                    if (statusSelect) {
                        statusSelect.value = user.isActive ? 'true' : 'false';
                    }
                    
                    // Set the form action URL with the user ID
                    document.getElementById('editUserForm').action = '/admin/users/' + userId;
                    
                    // Show the edit modal
                    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    editModal.show();
                })
                .catch(error => {
                    // Hide loading state
                    hideFormLoading('editUserForm');
                    
                    console.error('Error fetching user data:', error);
                    showErrorMessage('Failed to load user data. Please try again.');
                });
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                // Create a form to submit POST request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/users/' + userId + '/delete';
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Filter functionality
        function clearFilters() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('pageSizeFilter').value = '10';
            document.getElementById('pageInput').value = '0';
            
            // Add visual feedback
            const clearButton = document.getElementById('clearFiltersBtn');
            if (clearButton) {
                clearButton.innerHTML = '<i class="fas fa-check"></i>';
                clearButton.classList.remove('btn-warning', 'btn-outline-secondary');
                clearButton.classList.add('btn-success');
                
                setTimeout(() => {
                    clearButton.innerHTML = '<i class="fas fa-times"></i>';
                    clearButton.classList.remove('btn-success');
                    clearButton.classList.add('btn-outline-secondary');
                    updateActiveFiltersCount();
                }, 2000);
            }
            
            document.getElementById('filterForm').submit();
        }

        function applyFilters() {
            // Reset to first page when applying filters
            document.getElementById('pageInput').value = '0';
            document.getElementById('filterForm').submit();
        }

        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyFilters();
            }
        }

        function handleFilterChange() {
            // Auto-apply filters when dropdowns change
            applyFilters();
        }

        function handleSearchInput() {
            // Debounce search input to avoid too many requests
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        }

        function updateActiveFiltersCount() {
            const searchInput = document.getElementById('userSearchInput');
            const roleFilter = document.getElementById('roleFilter');
            const statusFilter = document.getElementById('statusFilter');
            const pageSizeFilter = document.getElementById('pageSizeFilter');
            
            let activeCount = 0;
            if (searchInput.value.trim()) activeCount++;
            if (roleFilter.value) activeCount++;
            if (statusFilter.value) activeCount++;
            if (pageSizeFilter.value && pageSizeFilter.value !== '10') activeCount++;
            
            // Update clear button to show active filter count
            const clearButton = document.getElementById('clearFiltersBtn');
            if (clearButton) {
                if (activeCount > 0) {
                    clearButton.innerHTML = `<i class="fas fa-times"></i> (${activeCount})`;
                    clearButton.classList.add('btn-warning');
                    clearButton.classList.remove('btn-outline-secondary');
            } else {
                    clearButton.innerHTML = '<i class="fas fa-times"></i>';
                    clearButton.classList.remove('btn-warning');
                    clearButton.classList.add('btn-outline-secondary');
                }
            }
        }


        // Standardized validation system (matching other forms in the system)
        function validateField(field) {
            const value = field.value.trim();
            const type = field.type;
            const pattern = field.pattern;
            const minLength = field.minLength;
            const maxLength = field.maxLength;
            const min = field.min;
            const max = field.max;
            const fieldName = field.name;

            // Remove previous validation classes
            field.classList.remove('is-valid', 'is-invalid');
            
            // Check required fields
            if (field.hasAttribute('required') && !value) {
                showFieldError(field, 'This field is required');
                return false;
            }

            // Skip validation for empty optional fields
            if (!field.hasAttribute('required') && !value) {
                return true;
            }

            // Validate by type
            switch (type) {
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        showFieldError(field, 'Please enter a valid email address');
                        return false;
                    }
                    break;

                case 'tel':
                    const phoneRegex = /^[\+]?[0-9\s\-\(\)]{7,20}$/;
                    if (!phoneRegex.test(value)) {
                        showFieldError(field, 'Please enter a valid phone number');
                        return false;
                    }
                    break;

                case 'text':
                    // Special validation for specific field types
                    if (fieldName === 'firstName' || fieldName === 'lastName') {
                        const nameRegex = /^[A-Za-z\s'-]{2,50}$/;
                        if (!nameRegex.test(value)) {
                            showFieldError(field, 'Name must be 2-50 characters, letters, spaces, hyphens, and apostrophes only. Numbers and special characters are not allowed.');
                return false;
                        }
                        // Additional check to ensure no numbers
                        if (/\d/.test(value)) {
                            showFieldError(field, 'Name cannot contain numbers. Please use only letters, spaces, hyphens, and apostrophes.');
                            return false;
                        }
                    } else if (fieldName === 'username') {
                        const usernameRegex = /^[A-Za-z0-9_]{3,20}$/;
                        if (!usernameRegex.test(value)) {
                            showFieldError(field, 'Username must be 3-20 characters, letters, numbers, and underscores only');
                return false;
                        }
                    } else if (fieldName === 'address') {
                        const addressRegex = /^[A-Za-z0-9\s,./-]{5,200}$/;
                        if (!addressRegex.test(value)) {
                            showFieldError(field, 'Address must be 5-200 characters (letters, numbers, spaces, commas, periods, slashes, and hyphens allowed)');
                            return false;
                        }
                    } else if (fieldName === 'city' || fieldName === 'state') {
                        const cityStateRegex = /^[A-Za-z\s]{2,50}$/;
                        if (!cityStateRegex.test(value)) {
                            showFieldError(field, 'Must be 2-50 characters, letters and spaces only. Numbers and special characters are not allowed.');
                            return false;
                        }
                        // Additional check to ensure no numbers
                        if (/\d/.test(value)) {
                            showFieldError(field, 'City/State cannot contain numbers. Please use only letters and spaces.');
                            return false;
                        }
                    } else if (fieldName === 'zipCode') {
                        const zipRegex = /^[A-Za-z0-9\s-]{3,10}$/;
                        if (!zipRegex.test(value)) {
                            showFieldError(field, 'ZIP code must be 3-10 characters');
                            return false;
                        }
                    }
                    break;

                case 'password':
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/;
                    if (!passwordRegex.test(value)) {
                        showFieldError(field, 'Password must be at least 8 characters with uppercase, lowercase, and number');
                return false;
                    }
                    break;

                case 'date':
                    const dateValue = new Date(value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (fieldName === 'dateOfBirth') {
                        const maxDate = new Date('2010-12-31');
                        if (dateValue > maxDate) {
                            showFieldError(field, 'Date of birth must be before 2011');
                return false;
                        }
                    } else if (dateValue < today) {
                        showFieldError(field, 'Cannot select a past date');
                        return false;
                    }
                    
                    if (min && dateValue < new Date(min)) {
                        showFieldError(field, `Date must be after ${min}`);
                return false;
                    }
                    if (max && dateValue > new Date(max)) {
                        showFieldError(field, `Date must be before ${max}`);
                        return false;
                    }
                    break;

                case 'number':
                    const numValue = parseFloat(value);
                    if (isNaN(numValue) || numValue < 0) {
                        showFieldError(field, 'Please enter a valid positive number');
                return false;
                    }
                    if (min && numValue < parseFloat(min)) {
                        showFieldError(field, `Value must be at least ${min}`);
                        return false;
                    }
                    if (max && numValue > parseFloat(max)) {
                        showFieldError(field, `Value must not exceed ${max}`);
                        return false;
                    }
                    break;
            }

            // Validate length
            if (minLength && minLength > 0 && value.length < minLength) {
                showFieldError(field, `Must be at least ${minLength} characters`);
                return false;
            }
            if (maxLength && maxLength > 0 && value.length > maxLength) {
                showFieldError(field, `Must not exceed ${maxLength} characters`);
                return false;
            }

            // Validate pattern
            if (pattern) {
                const regex = new RegExp(pattern);
                if (!regex.test(value)) {
                    showFieldError(field, field.title || 'Please enter a valid value');
                return false;
                }
            }

            // Show success state
            showFieldSuccess(field);
            return true;
        }

        function showFieldError(field, message) {
                field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            
            // Remove existing error message
            const existingError = field.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }
            
            // Add new error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }

        function showFieldSuccess(field) {
                field.classList.add('is-valid');
            field.classList.remove('is-invalid');
            
            // Remove error message
            const existingError = field.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }
        }

        function validateForm(form) {
            const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;
            let firstInvalidField = null;

            inputs.forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                    if (!firstInvalidField) {
                        firstInvalidField = input;
                    }
                }
            });

            if (!isValid && firstInvalidField) {
                firstInvalidField.focus();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return isValid;
        }

        // Loading state functions
        function showFormLoading(formId) {
            const form = document.getElementById(formId);
            if (formId === 'userForm') {
                document.getElementById('formLoading').classList.remove('d-none');
                document.getElementById('formContent').classList.add('d-none');
            } else if (formId === 'editUserForm') {
                document.getElementById('editFormLoading').classList.remove('d-none');
                document.getElementById('editFormContent').classList.add('d-none');
            }
            
            // Disable submit button
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            }
        }
        
        function hideFormLoading(formId) {
            if (formId === 'userForm') {
                document.getElementById('formLoading').classList.add('d-none');
                document.getElementById('formContent').classList.remove('d-none');
            } else if (formId === 'editUserForm') {
                document.getElementById('editFormLoading').classList.add('d-none');
                document.getElementById('editFormContent').classList.remove('d-none');
            }
            
            // Re-enable submit button
            const form = document.getElementById(formId);
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                if (formId === 'userForm') {
                    submitBtn.innerHTML = 'Create User';
                } else {
                    submitBtn.innerHTML = 'Update User';
                }
            }
        }
        
        // Success/Error message functions
        function showSuccessMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(alertDiv, mainContent.firstChild);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }
        
        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(alertDiv, mainContent.firstChild);
                
                // Auto-remove after 7 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 7000);
            }
        }

        // Form reset functions
        function resetForm(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.reset();
                // Clear validation states
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.classList.remove('is-valid', 'is-invalid');
                });
                // Clear error messages
                const errorDivs = form.querySelectorAll('.invalid-feedback');
                errorDivs.forEach(div => {
                    div.remove();
                });
            }
        }
        
        function resetModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Hide loading states
                const loadingDivs = modal.querySelectorAll('[id$="Loading"]');
                loadingDivs.forEach(div => div.classList.add('d-none'));
                
                // Show form content
                const contentDivs = modal.querySelectorAll('[id$="Content"]');
                contentDivs.forEach(div => div.classList.remove('d-none'));
                
                // Reset form
                const form = modal.querySelector('form');
                if (form) {
                    resetForm(form.id);
                }
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any loading states on page load (in case of errors)
            hideFormLoading('userForm');
            hideFormLoading('editUserForm');
            
            // Clear filters button
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearFilters);
            }

            // Search input
            const userSearchInput = document.getElementById('userSearchInput');
            if (userSearchInput) {
                userSearchInput.addEventListener('keypress', handleSearchKeyPress);
                userSearchInput.addEventListener('input', function() {
                    handleSearchInput();
                    updateActiveFiltersCount();
                });
            }
            
            // Modal event listeners for form reset
            const userModal = document.getElementById('userModal');
            if (userModal) {
                userModal.addEventListener('hidden.bs.modal', function() {
                    resetModal('userModal');
                });
                
                // Clear loading state when modal is shown (in case of errors)
                userModal.addEventListener('show.bs.modal', function() {
                    hideFormLoading('userForm');
                });
            }
            
            const editUserModal = document.getElementById('editUserModal');
            if (editUserModal) {
                editUserModal.addEventListener('hidden.bs.modal', function() {
                    resetModal('editUserModal');
                });
                
                // Clear loading state when modal is shown (in case of errors)
                editUserModal.addEventListener('show.bs.modal', function() {
                    hideFormLoading('editUserForm');
                });
            }
            
            const viewUserModal = document.getElementById('viewUserModal');
            if (viewUserModal) {
                viewUserModal.addEventListener('hidden.bs.modal', function() {
                    resetModal('viewUserModal');
                });
            }

            // Role filter
            const roleFilter = document.getElementById('roleFilter');
            if (roleFilter) {
                roleFilter.addEventListener('change', function() {
                    handleFilterChange();
                    updateActiveFiltersCount();
                });
            }

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    handleFilterChange();
                    updateActiveFiltersCount();
                });
            }

            // Page size filter
            const pageSizeFilter = document.getElementById('pageSizeFilter');
            if (pageSizeFilter) {
                pageSizeFilter.addEventListener('change', function() {
                    handleFilterChange();
                    updateActiveFiltersCount();
                });
            }

            // Initialize active filters count on page load
            updateActiveFiltersCount();

            // Set minimum date to today for all date inputs except DOB
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                // Don't set min date for DOB fields - they should allow past dates
                if (!input.name.includes('dateOfBirth') && !input.id.includes('dateOfBirth')) {
                    input.setAttribute('min', today);
                }
            });

            // Add comprehensive real-time validation to all forms
            const allForms = document.querySelectorAll('form');
            allForms.forEach(form => {
                // Add submit validation
                form.addEventListener('submit', function(e) {
                    if (!validateForm(this)) {
                        e.preventDefault();
                        return false;
                    }
                });

                // Add real-time validation to inputs
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        validateField(this);
                    });

                    input.addEventListener('input', function() {
                        // Clear validation state on input
                        this.classList.remove('is-valid', 'is-invalid');
                        const errorDiv = this.parentNode.querySelector('.invalid-feedback');
                        if (errorDiv) {
                            errorDiv.remove();
                        }
                    });

                    input.addEventListener('change', function() {
                        validateField(this);
                    });
                });
            });

            // Add loading states to form submission
            const filterForm = document.getElementById('filterForm');
            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    const submitBtn = filterForm.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Searching...';
                    submitBtn.disabled = true;
                    }
                });
            }

            // Add specific loading states for user forms
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', function(e) {
                    // Show loading state
                    showFormLoading('userForm');
                    
                    // Set a timeout to hide loading state if form takes too long
                    setTimeout(() => {
                        hideFormLoading('userForm');
                    }, 10000); // 10 seconds timeout
                });
            }

            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', function(e) {
                    // Show loading state
                    showFormLoading('editUserForm');
                });
            }
        });
    </script>
</body>
</html>