<!DOCTYPE html>
<!-- Customer dashboard template for booking management and service requests -->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <!-- Meta tags for responsive design and character encoding -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title
      th:text="${currentUser != null ? (currentUser.firstName + '''s Dashboard - Vehicle Service System') : 'Customer Dashboard - Vehicle Service System'}"
    >
      Customer Dashboard - Vehicle Service System
    </title>
    <!-- External CSS libraries for styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="/css/dashboard.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <a href="/customer/dashboard" class="sidebar-brand">
          <i class="fas fa-car"></i>
          Vehicle Service
        </a>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-item">
          <a href="/customer/dashboard" class="nav-link active">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </a>
        </div>
        <div class="nav-item">
          <a href="/customer/feedbacks" class="nav-link">
            <i class="fas fa-comments"></i>
            My Feedback
          </a>
        </div>
        <div class="nav-item">
          <a href="/logout" class="nav-link">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="content-area">
        <!-- Page Header -->
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1
                class="page-title"
                th:text="${currentUser != null ? (currentUser.firstName + '''s Dashboard') : 'Customer Dashboard'}"
              >
                Customer Dashboard
              </h1>
              <p
                class="page-subtitle"
                th:text="${currentUser != null ? (('Welcome back, ' + currentUser.firstName) + '! Manage your vehicle service bookings and appointments') : 'Manage your vehicle service bookings and appointments'}"
              >
                Manage your vehicle service bookings and appointments
              </p>
            </div>
            <div class="user-profile">
              <div
                class="avatar"
                th:text="${currentUser != null ? (currentUser.firstName.substring(0,1) + currentUser.lastName.substring(0,1)).toUpperCase() : 'CU'}"
              >
                CU
              </div>
              <div>
                <div
                  class="fw-semibold"
                  th:text="${currentUser != null ? ((currentUser.firstName + ' ') + currentUser.lastName) : 'Customer User'}"
                >
                  Customer User
                </div>
                <small class="text-muted">Vehicle Owner</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Success/Error Messages -->
        <div
          th:if="${message}"
          class="alert alert-success alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-check-circle me-2"></i>
          <span th:text="${message}"></span>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            title="Close alert"
            aria-label="Close alert"
          ></button>
        </div>

        <div
          th:if="${error}"
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-exclamation-circle me-2"></i>
          <span th:text="${error}"></span>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            title="Close alert"
            aria-label="Close alert"
          ></button>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon primary">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div
              class="stat-number"
              th:text="${customerBookings != null ? customerBookings.size() : 0}"
            >
              0
            </div>
            <div class="stat-label">My Bookings</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div
              class="stat-number"
              th:text="${customerBookings != null ? customerBookings.size() : 0}"
            >
              0
            </div>
            <div class="stat-label">Total Bookings</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon warning">
              <i class="fas fa-clock"></i>
            </div>
            <div
              class="stat-number"
              th:text="${pendingBookings != null ? pendingBookings : 0}"
            >
              0
            </div>
            <div class="stat-label">Pending Payment</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon info">
              <i class="fas fa-cogs"></i>
            </div>
            <div
              class="stat-number"
              th:text="${availableServices != null ? availableServices.size() : 0}"
            >
              0
            </div>
            <div class="stat-label">Services Available</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <div
            class="action-card"
            data-bs-toggle="modal"
            data-bs-target="#bookServiceModal"
          >
            <i class="fas fa-calendar-plus"></i>
            <h5>Book Service</h5>
            <p>Schedule new service appointment</p>
          </div>
          <div
            class="action-card"
            data-bs-toggle="modal"
            data-bs-target="#profileModal"
          >
            <i class="fas fa-user-edit"></i>
            <h5>Profile</h5>
            <p>Manage your account</p>
          </div>
        </div>
        <!-- My Bookings Section -->
        <div class="card mb-3" id="my-bookings">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>
                My Bookings
              </h5>
            </div>
          </div>
          <div class="card-body p-0">
            <div
              th:if="${customerBookings != null and !customerBookings.empty}"
            >
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>BOOKING</th>
                      <th>SERVICE</th>
                      <th>VEHICLE</th>
                      <th>DATE</th>
                      <th>STATUS</th>
                      <th>PRICE</th>
                      <th>NOTES</th>
                      <th>ACTIONS</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="booking : ${customerBookings}">
                      <td>
                        <div class="d-flex align-items-center">
                          <div
                            class="avatar me-2 customer-avatar-booking"
                            th:text="${booking.bookingNumber.substring(2,4)}"
                          >
                            BK
                          </div>
                          <div>
                            <div
                              class="fw-semibold"
                              th:text="${booking.bookingNumber}"
                            >
                              BK001
                            </div>
                            <small
                              class="text-muted"
                              th:text="${#temporals.format(booking.bookingDate, 'MMM dd, yyyy')}"
                              >Jan 15, 2024</small
                            >
                          </div>
                        </div>
                      </td>
                      <td th:text="${booking.serviceType}">Oil Change</td>
                      <td th:text="${booking.vehicleNumber}">ABC-1234</td>
                      <td
                        th:text="${#temporals.format(booking.bookingDate, 'MMM dd, yyyy')}"
                      >
                        Jan 15, 2024
                      </td>
                      <td>
                        <span
                          class="status-badge"
                          th:classappend="${booking.paymentStatus.name() == 'PENDING'} ? 'status-pending' : (${booking.paymentStatus.name() == 'PARTIAL'} ? 'status-warning' : (${booking.paymentStatus.name() == 'PAID'} ? 'status-confirmed' : 'status-cancelled'))"
                          th:text="${booking.paymentStatus}"
                          >PENDING</span
                        >
                      </td>
                      <td>
                        <span
                          th:if="${booking.totalPrice != null}"
                          th:text="'Rs. ' + ${#numbers.formatDecimal(booking.totalPrice, 1, 2)}"
                          >Rs. 0.00</span
                        >
                        <span
                          th:if="${booking.totalPrice == null}"
                          class="text-muted"
                          >TBD</span
                        >
                      </td>
                      <td>
                        <span
                          th:if="${booking.notes != null and !booking.notes.empty}"
                          th:text="${booking.notes}"
                          >Notes</span
                        >
                        <span
                          th:if="${booking.notes == null or booking.notes.empty}"
                          class="text-muted"
                          >No notes</span
                        >
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button
                            class="btn-action"
                            title="View Details"
                            th:onclick="'viewBooking(' + ${booking.id} + ')'"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                          <button
                            th:if="${booking.paymentStatus.name() == 'PAID'}"
                            class="btn-action btn-action-success"
                            title="Submit Feedback"
                            th:onclick="'checkFeedbackAndSubmit(' + ${booking.id} + ')'"
                          >
                            <i class="fas fa-comment-dots"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div
              th:if="${customerBookings == null or customerBookings.empty}"
              class="text-center p-4"
            >
              <div class="empty-state">
                <i class="fas fa-calendar-times fa-2x"></i>
                <h5>No bookings found</h5>
                <p>You haven't made any service bookings yet.</p>
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#bookServiceModal"
                >
                  <i class="fas fa-plus me-2"></i>Book Your First Service
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Book Service Modal -->
    <div
      class="modal fade"
      id="bookServiceModal"
      tabindex="-1"
      aria-labelledby="bookServiceModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="bookServiceModalLabel">
              <i class="fas fa-calendar-plus me-2 text-primary"></i>Book New
              Service
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form
            th:action="@{/customer/bookings/save}"
            th:object="${booking}"
            method="post"
          >
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label">
                    <i class="fas fa-car me-2 text-primary"></i>Vehicle Number
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    th:field="*{vehicleNumber}"
                    placeholder="Enter vehicle number (e.g., ABC-1234)"
                    required
                    pattern="[A-Za-z]{3}-[0-9]{4}"
                    title="Please enter vehicle number in format ABC-1234 (3 letters, hyphen, 4 numbers)"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <label class="form-label">
                    <i class="fas fa-wrench me-2 text-primary"></i>Service Type
                    <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    th:field="*{serviceType}"
                    id="serviceType"
                    required
                  >
                    <option value="">Select Service</option>
                    <!-- Basic Services -->
                    <option value="Oil Change">Oil Change</option>
                    <option value="Tire Service">Tire Service</option>
                    <option value="Air Filter Replacement">Air Filter Replacement</option>
                    <option value="Spark Plug Replacement">Spark Plug Replacement</option>
                    <option value="General Maintenance">General Maintenance</option>
                    <!-- Advanced Services -->
                    <option value="Engine Inspection">Engine Inspection</option>
                    <option value="Engine Repair">Engine Repair</option>
                    <option value="Transmission Service">Transmission Service</option>
                    <option value="Brake Service">Brake Service</option>
                    <option value="Electrical Service">Electrical Service</option>
                    <option value="AC Service">AC Service</option>
                    <option value="Major Overhaul">Major Overhaul</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label">
                    <i class="fas fa-calendar me-2 text-primary"></i>Booking
                    Date <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    id="bookingDate"
                    name="bookingDate"
                    onchange="loadAvailableSlots()"
                    required
                    title="Please select a date at least 2 days in advance (if today is 28th, you can only select from 30th onwards)"
                  />
                </div>
                <div class="col-md-6 mb-2 time-slot-container">
                  <label class="form-label">
                    <i class="fas fa-clock me-2 text-primary"></i>Time Slot
                    <span class="text-danger">*</span>
                    <small class="text-muted d-block"
                      >Available slots will appear after selecting date and
                      service</small
                    >
                  </label>
                  <div class="d-flex gap-2">
                    <select
                      class="form-select"
                      id="timeSlot"
                      name="timeSlot"
                      onchange="updateBookingTime()"
                      required
                      disabled
                    >
                      <option value="">Select a time slot</option>
                    </select>
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm"
                      onclick="loadAvailableSlots()"
                      title="Refresh slots"
                    >
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </div>
                  <div id="slotStatus" class="form-text slot-status"></div>
                </div>
              </div>

              <!-- Payment Information -->
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label for="payingAmount" class="form-label">
                    <i class="fas fa-money-bill-wave me-2 text-primary"></i>Paying Amount (LKR)
                  </label>
                    <input
                      type="number"
                      class="form-control"
                      id="payingAmount"
                      name="payingAmount"
                      step="0.01"
                      min="0"
                      placeholder="Enter amount you want to pay"
                    />
                  <div class="form-text">
                    Enter the amount you want to pay for this service
                  </div>
                </div>
                <div class="col-md-6 mb-2">
                  <label for="paymentMethod" class="form-label">
                    <i class="fas fa-credit-card me-2 text-primary"></i>Payment Method
                  </label>
                  <select
                    class="form-select"
                    id="paymentMethod"
                    name="paymentMethod"
                    required
                  >
                    <option value="">Select Payment Method</option>
                    <option value="CASH">Cash</option>
                    <option value="VISA">Visa Card</option>
                    <option value="MASTERCARD">Mastercard</option>
                    <option value="AMEX">American Express</option>
                    <option value="CREDIT_CARD">Credit Card</option>
                    <option value="DEBIT_CARD">Debit Card</option>
                  </select>
                  <div class="form-text">
                    Choose your preferred payment method
                  </div>
                </div>
              </div>

              <!-- Simple Service Price -->
              <div class="row">
                <div class="col-12 mb-3">
                  <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                      <h6 class="card-title mb-3 fw-bold text-dark">
                        <i class="fas fa-calculator me-2 text-primary"></i>Service Price
                      </h6>
                      <div class="text-center">
                        <div class="h4 mb-0 text-success fw-bold">
                              LKR <span id="servicePriceDisplay">0.00</span>
                            </div>
                        <div class="text-muted small mt-1">
                          Base service price (processing fees may apply for card payments)
                          </div>
                        </div>
                    </div>
                  </div>
                </div>
              </div>


              <div class="mb-2">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  th:field="*{notes}"
                  rows="3"
                  placeholder="Enter any additional notes or special instructions..."
                  maxlength="500"
                  title="Enter any additional notes (max 500 characters)"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-calendar-plus me-2"></i>Book Service
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- My Bookings Modal -->
    <div
      class="modal fade"
      id="myBookingsModal"
      tabindex="-1"
      aria-labelledby="myBookingsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="myBookingsModalLabel">
              <i class="fas fa-list me-2"></i>All My Bookings
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-0">
            <div
              th:if="${customerBookings != null and !customerBookings.empty}"
            >
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>BOOKING</th>
                      <th>SERVICE</th>
                      <th>VEHICLE</th>
                      <th>DATE</th>
                      <th>STATUS</th>
                      <th>PRICE</th>
                      <th>NOTES</th>
                      <th>ACTIONS</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="booking : ${customerBookings}">
                      <td>
                        <div class="d-flex align-items-center">
                          <div
                            class="avatar me-2 customer-avatar-completed"
                            th:text="${booking.bookingNumber.substring(2,4)}"
                          >
                            BK
                          </div>
                          <div>
                            <div
                              class="fw-semibold"
                              th:text="${booking.bookingNumber}"
                            >
                              BK001
                            </div>
                            <small
                              class="text-muted"
                              th:text="${#temporals.format(booking.bookingDate, 'MMM dd, yyyy')}"
                              >Jan 15, 2024</small
                            >
                          </div>
                        </div>
                      </td>
                      <td th:text="${booking.serviceType}">Oil Change</td>
                      <td th:text="${booking.vehicleNumber}">ABC-1234</td>
                      <td
                        th:text="${#temporals.format(booking.bookingDate, 'MMM dd, yyyy')}"
                      >
                        Jan 15, 2024
                      </td>
                      <td>
                        <span
                          class="status-badge"
                          th:classappend="${booking.paymentStatus.name() == 'PENDING'} ? 'status-pending' : (${booking.paymentStatus.name() == 'PARTIAL'} ? 'status-warning' : (${booking.paymentStatus.name() == 'PAID'} ? 'status-confirmed' : 'status-cancelled'))"
                          th:text="${booking.paymentStatus}"
                          >PENDING</span
                        >
                      </td>
                      <td>
                        <span
                          th:if="${booking.totalPrice != null}"
                          th:text="'Rs. ' + ${#numbers.formatDecimal(booking.totalPrice, 1, 2)}"
                          >Rs. 0.00</span
                        >
                        <span
                          th:if="${booking.totalPrice == null}"
                          class="text-muted"
                          >TBD</span
                        >
                      </td>
                      <td>
                        <span
                          th:if="${booking.notes != null and !booking.notes.empty}"
                          th:text="${booking.notes}"
                          >Notes</span
                        >
                        <span
                          th:if="${booking.notes == null or booking.notes.empty}"
                          class="text-muted"
                          >No notes</span
                        >
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button
                            class="btn-action"
                            title="View Details"
                            th:onclick="'viewBooking(' + ${booking.id} + ')'"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                          <button
                            th:if="${booking.paymentStatus.name() == 'PAID'}"
                            class="btn-action btn-action-success"
                            title="Submit Feedback"
                            th:onclick="'checkFeedbackAndSubmit(' + ${booking.id} + ')'"
                          >
                            <i class="fas fa-comment-dots"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div
              th:if="${customerBookings == null or customerBookings.empty}"
              class="text-center p-4"
            >
              <div class="empty-state">
                <i class="fas fa-calendar-times fa-2x"></i>
                <h5>No bookings found</h5>
                <p>You haven't made any service bookings yet.</p>
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#bookServiceModal"
                >
                  <i class="fas fa-plus me-2"></i>Book Your First Service
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Services Modal -->
    <div
      class="modal fade"
      id="servicesModal"
      tabindex="-1"
      aria-labelledby="servicesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="servicesModalLabel">
              <i class="fas fa-cogs me-2"></i>Available Services
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="service-card">
                  <div class="d-flex align-items-center mb-3">
                    <div class="service-icon me-3">
                      <i class="fas fa-oil-can text-primary"></i>
                    </div>
                    <div>
                      <h6 class="mb-1">Oil Change</h6>
                      <small class="text-muted">Regular maintenance</small>
                    </div>
                  </div>
                  <p class="text-muted small">
                    Complete oil change service with premium quality oil and
                    filter replacement.
                  </p>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <span class="fw-bold text-primary">Get Quote</span>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="selectService('Oil Change')"
                    >
                      Select
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="service-card">
                  <div class="d-flex align-items-center mb-3">
                    <div class="service-icon me-3">
                      <i class="fas fa-cog text-success"></i>
                    </div>
                    <div>
                      <h6 class="mb-1">Tire Rotation</h6>
                      <small class="text-muted">Tire maintenance</small>
                    </div>
                  </div>
                  <p class="text-muted small">
                    Professional tire rotation to ensure even wear and extend
                    tire life.
                  </p>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <span class="fw-bold text-primary">Get Quote</span>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="selectService('Tire Rotation')"
                    >
                      Select
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="service-card">
                  <div class="d-flex align-items-center mb-3">
                    <div class="service-icon me-3">
                      <i class="fas fa-wrench text-warning"></i>
                    </div>
                    <div>
                      <h6 class="mb-1">Engine Repair</h6>
                      <small class="text-muted">Engine diagnostics</small>
                    </div>
                  </div>
                  <p class="text-muted small">
                    Comprehensive engine diagnostics and repair services by
                    certified technicians.
                  </p>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <span class="fw-bold text-primary">Get Quote</span>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="selectService('Engine Repair')"
                    >
                      Select
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Booking Modal -->
    <div
      class="modal fade"
      id="viewBookingModal"
      tabindex="-1"
      aria-labelledby="viewBookingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewBookingModalLabel">
              <i class="fas fa-eye me-2"></i>Booking Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="viewBookingContent">
              <!-- Booking details will be loaded here -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Modal -->
    <div
      class="modal fade"
      id="profileModal"
      tabindex="-1"
      aria-labelledby="profileModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileModalLabel">
              <i class="fas fa-user-edit me-2"></i>Edit Profile
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form
            id="profileForm"
            th:action="@{/customer/profile/update}"
            method="post"
            th:object="${currentUser}"
            novalidate
          >
            <div class="modal-body">
              <!-- Loading indicator -->
              <div id="profileFormLoading" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Updating profile...</p>
              </div>

              <!-- Form content -->
              <div id="profileFormContent">
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-user me-2 text-primary"></i>First Name *
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="firstName"
                      th:field="*{firstName}"
                      placeholder="Enter your first name"
                      required
                      minlength="2"
                      maxlength="50"
                      pattern="[A-Za-z\s'-]+"
                      title="First name must be 2-50 characters, letters, spaces, hyphens, and apostrophes only"
                      onkeypress="return /[A-Za-z\s'-]/.test(event.key)"
                    />
                    <div class="invalid-feedback" id="firstNameError"></div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-user me-2 text-primary"></i>Last Name *
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="lastName"
                      th:field="*{lastName}"
                      placeholder="Enter your last name"
                      required
                      minlength="2"
                      maxlength="50"
                      pattern="[A-Za-z\s'-]+"
                      title="Last name must be 2-50 characters, letters, spaces, hyphens, and apostrophes only"
                      onkeypress="return /[A-Za-z\s'-]/.test(event.key)"
                    />
                    <div class="invalid-feedback" id="lastNameError"></div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-envelope me-2 text-primary"></i>Email
                      Address *
                    </label>
                    <input
                      type="email"
                      class="form-control"
                      id="email"
                      th:field="*{email}"
                      placeholder="Enter email address (e.g., user@example.com)"
                      required
                      maxlength="100"
                      title="Please enter a valid email address"
                    />
                    <div class="invalid-feedback" id="emailError"></div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                    </label>
                    <input
                      type="tel"
                      class="form-control"
                      id="phoneNumber"
                      th:field="*{phoneNumber}"
                      placeholder="Enter phone number (e.g., +94 77 123 4567)"
                      maxlength="20"
                      pattern="[\+]?[0-9\s\-\(\)]{7,20}"
                      title="Please enter a valid phone number"
                    />
                    <div class="invalid-feedback" id="phoneNumberError"></div>
                  </div>
                </div>

                <div class="mb-2">
                  <label class="form-label">
                    <i class="fas fa-map-marker-alt me-2 text-primary"></i
                    >Address
                  </label>
                  <textarea
                    class="form-control"
                    id="address"
                    th:field="*{address}"
                    placeholder="Enter your full address"
                    rows="3"
                    maxlength="200"
                    title="Please enter your address"
                  >
                  </textarea>
                  <div class="invalid-feedback" id="addressError"></div>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label">
                      <i class="fas fa-city me-2 text-primary"></i>City
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="city"
                      th:field="*{city}"
                      placeholder="Enter city name"
                      maxlength="50"
                      pattern="[A-Za-z\s]+"
                      title="Please enter a valid city name"
                      onkeypress="return /[A-Za-z\s]/.test(event.key)"
                    />
                    <div class="invalid-feedback" id="cityError"></div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label">
                      <i class="fas fa-map me-2 text-primary"></i>State
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="state"
                      th:field="*{state}"
                      placeholder="Enter state name"
                      maxlength="50"
                      pattern="[A-Za-z\s]+"
                      title="Please enter a valid state name"
                      onkeypress="return /[A-Za-z\s]/.test(event.key)"
                    />
                    <div class="invalid-feedback" id="stateError"></div>
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label">
                      <i class="fas fa-mail-bulk me-2 text-primary"></i>ZIP Code
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="zipCode"
                      th:field="*{zipCode}"
                      placeholder="Enter ZIP/postal code"
                      maxlength="10"
                      title="Please enter a valid ZIP/postal code"
                    />
                    <div class="invalid-feedback" id="zipCodeError"></div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-calendar me-2 text-primary"></i>Date of
                      Birth
                    </label>
                    <input
                      type="date"
                      class="form-control"
                      id="dateOfBirth"
                      th:field="*{dateOfBirth}"
                      title="Please select your date of birth"
                    />
                    <div class="invalid-feedback" id="dateOfBirthError"></div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-info-circle me-2 text-primary"></i
                      >Account Status
                    </label>
                    <div class="form-control-plaintext">
                      <span
                        class="badge bg-success"
                        th:if="${currentUser.isActive}"
                        >Active</span
                      >
                      <span
                        class="badge bg-danger"
                        th:unless="${currentUser.isActive}"
                        >Inactive</span
                      >
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-calendar-plus me-2 text-primary"></i
                      >Member Since
                    </label>
                    <div
                      class="form-control-plaintext"
                      th:text="${#temporals.format(currentUser.createdAt, 'MMM dd, yyyy')}"
                    >
                      Jan 15, 2024
                    </div>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label">
                      <i class="fas fa-calendar-check me-2 text-primary"></i
                      >Last Updated
                    </label>
                    <div
                      class="form-control-plaintext"
                      th:text="${#temporals.format(currentUser.updatedAt, 'MMM dd, yyyy')}"
                    >
                      Jan 15, 2024
                    </div>
                  </div>
                </div>
              </div>
              <!-- End profileFormContent -->
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="resetProfileForm()"
              >
                <i class="fas fa-undo me-2"></i>Reset
              </button>
              <button
                type="button"
                class="btn btn-outline-warning"
                onclick="openPasswordModal()"
              >
                <i class="fas fa-key me-2"></i>Change Password
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Update Profile
              </button>
            </div>
          </form>

          <!-- Password Change Section -->
          <div
            class="modal fade"
            id="passwordModal"
            tabindex="-1"
            aria-labelledby="passwordModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="passwordModalLabel">
                    <i class="fas fa-lock me-2"></i>Change Password
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <form
                  id="passwordForm"
                  th:action="@{/customer/profile/change-password}"
                  method="post"
                  novalidate
                >
                  <div class="modal-body">
                    <!-- Loading indicator -->
                    <div id="passwordFormLoading" class="text-center d-none">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2">Changing password...</p>
                    </div>

                    <!-- Form content -->
                    <div id="passwordFormContent">
                      <div class="mb-3">
                        <label class="form-label">
                          <i class="fas fa-key me-2 text-primary"></i>Current
                          Password *
                        </label>
                        <input
                          type="password"
                          class="form-control"
                          id="currentPassword"
                          name="currentPassword"
                          placeholder="Enter your current password"
                          required
                          minlength="6"
                          maxlength="100"
                          title="Please enter your current password"
                        />
                        <div
                          class="invalid-feedback"
                          id="currentPasswordError"
                        ></div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">
                          <i class="fas fa-lock me-2 text-primary"></i>New
                          Password *
                        </label>
                        <input
                          type="password"
                          class="form-control"
                          id="newPassword"
                          name="newPassword"
                          placeholder="Enter your new password"
                          required
                          minlength="6"
                          maxlength="100"
                          title="Password must be at least 6 characters long"
                        />
                        <div
                          class="invalid-feedback"
                          id="newPasswordError"
                        ></div>
                        <div class="form-text">
                          Password must be at least 6 characters long
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">
                          <i class="fas fa-lock me-2 text-primary"></i>Confirm
                          New Password *
                        </label>
                        <input
                          type="password"
                          class="form-control"
                          id="confirmPassword"
                          name="confirmPassword"
                          placeholder="Confirm your new password"
                          required
                          minlength="6"
                          maxlength="100"
                          title="Please confirm your new password"
                        />
                        <div
                          class="invalid-feedback"
                          id="confirmPasswordError"
                        ></div>
                      </div>
                    </div>
                    <!-- End passwordFormContent -->
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-warning">
                      <i class="fas fa-key me-2"></i>Change Password
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
      // Service pricing data - removed hardcoded values, now uses backend API

      // Calculate service pricing using backend strategy
      function calculateServicePricing(serviceType, callback) {
        if (!serviceType) {
          callback({ basePrice: 0, additionalCharges: 0, totalPrice: 0 });
          return;
        }

        // Make API call to get pricing from backend
        fetch('/customer/pricing/calculate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: `serviceType=${encodeURIComponent(serviceType)}`
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            callback({
              basePrice: parseFloat(data.basePrice) || 0,
              additionalCharges: parseFloat(data.additionalCharges) || 0,
              totalPrice: parseFloat(data.totalPrice) || 0
            });
          } else {
            // No fallback - show error if backend fails
            callback({
              basePrice: 0,
              additionalCharges: 0,
              totalPrice: 0
            });
          }
        })
        .catch(error => {
          // No fallback - show error if backend fails
          console.error('Error fetching pricing:', error);
          callback({
            basePrice: 0,
            additionalCharges: 0,
            totalPrice: 0
          });
        });
      }

      // Service price update using backend API
      function updateServicePrice() {
        const serviceType = document.getElementById("serviceType").value;
        
        if (!serviceType) {
          document.getElementById("servicePriceDisplay").textContent = "0.00";
          return;
        }
        
        // Call backend pricing API
        fetch('/customer/pricing/calculate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: `serviceType=${encodeURIComponent(serviceType)}`
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const price = parseFloat(data.basePrice) || 0;
            document.getElementById("servicePriceDisplay").textContent = price.toFixed(2);
          } else {
            document.getElementById("servicePriceDisplay").textContent = "0.00";
          }
        })
        .catch(error => {
          console.error('Error fetching pricing:', error);
          document.getElementById("servicePriceDisplay").textContent = "0.00";
        });
      }

      // Add event listener for service type changes
      document.addEventListener('DOMContentLoaded', function() {
        const serviceTypeSelect = document.getElementById("serviceType");
        if (serviceTypeSelect) {
          serviceTypeSelect.addEventListener('change', function() {
            updateServicePrice();
          });
        }
      });

      function loadAvailableSlots() {
        const dateInput = document.getElementById("bookingDate");
        const serviceTypeSelect = document.getElementById("serviceType");
        const timeSlotSelect = document.getElementById("timeSlot");
        const slotStatus = document.getElementById("slotStatus");

        if (!dateInput.value) {
          timeSlotSelect.innerHTML =
            '<option value="">Select a time slot</option>';
          timeSlotSelect.disabled = true;
          slotStatus.innerHTML =
            '<span class="text-muted">Please select a date first</span>';
          return;
        }

        // Clear and add loading option
        timeSlotSelect.innerHTML = '<option value="">Loading slots...</option>';
        timeSlotSelect.disabled = true;
        slotStatus.innerHTML =
          '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Loading available slots...</span>';

        // Get service type for filtering slots
        const serviceType = serviceTypeSelect.value || "";
        const url = serviceType
          ? `/customer/slots/available?date=${
              dateInput.value
            }&serviceType=${encodeURIComponent(serviceType)}`
          : `/customer/slots/available?date=${dateInput.value}`;

        // Fetch available slots from API with real-time data
        console.log("Fetching slots from URL:", url);
        fetch(url)
          .then((response) => {
            console.log("Response status:", response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((slots) => {
            console.log("Received slots (real-time):", slots);
            populateTimeSlots(slots);
          })
          .catch((error) => {
            console.error("Error loading slots:", error);
            timeSlotSelect.innerHTML =
              '<option value="">Error loading slots</option>';
            timeSlotSelect.disabled = false;
            slotStatus.innerHTML =
              '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error loading slots. Please try again.</span>';
          });
      }

      // Function to populate time slots dropdown
      function populateTimeSlots(slots) {
        console.log("populateTimeSlots called with:", slots);
        const timeSlotSelect = document.getElementById("timeSlot");
        const slotStatus = document.getElementById("slotStatus");

        if (!slots || slots.length === 0) {
          console.log("No slots available");
          timeSlotSelect.innerHTML =
            '<option value="">No slots available</option>';
          timeSlotSelect.disabled = false;
          slotStatus.innerHTML =
            '<span class="text-warning"><i class="fas fa-exclamation-circle me-1"></i>No available slots for this date and service type</span>';
          return;
        }

        // Clear and populate dropdown
        timeSlotSelect.innerHTML =
          '<option value="">Select a time slot</option>';
        console.log("Processing", slots.length, "slots");

        let availableCount = 0;
        slots.forEach((slot, index) => {
          console.log(`Slot ${index}:`, slot);
          if (slot.available) {
            const option = document.createElement("option");
            option.value = slot.startTime;
            option.textContent = `${slot.formattedTime} (${slot.remainingSlots} slots left)`;
            timeSlotSelect.appendChild(option);
            availableCount++;
            console.log("Added option:", option.textContent);
          }
        });

        timeSlotSelect.disabled = false;
        slotStatus.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>${availableCount} available slots found</span>`;
        console.log("Final dropdown options:", timeSlotSelect.options.length);
      }

      function updateBookingTime() {
        // This function can be used to update any time-related logic
        console.log(
          "Time slot selected:",
          document.getElementById("timeSlot").value
        );
      }

      // View booking details
      function viewBooking(bookingId) {
        fetch(`/customer/bookings/${bookingId}`)
          .then((response) => response.json())
          .then((booking) => {
            const content = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Booking Number</label>
                                    <p class="form-control-plaintext">${
                                      booking.bookingNumber
                                    }</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Service Type</label>
                                    <p class="form-control-plaintext">${
                                      booking.serviceType
                                    }</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Vehicle Number</label>
                                    <p class="form-control-plaintext">${
                                      booking.vehicleNumber
                                    }</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Booking Date</label>
                                    <p class="form-control-plaintext">${new Date(
                                      booking.bookingDate
                                    ).toLocaleDateString()}</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Status</label>
                                    <p class="form-control-plaintext">
                                        <span class="badge ${
                                          booking.paymentStatus === "PENDING"
                                            ? "bg-warning"
                                            : booking.paymentStatus === "PAID"
                                            ? "bg-success"
                                            : booking.paymentStatus ===
                                              "PARTIAL"
                                            ? "bg-info"
                                            : "bg-secondary"
                                        }">
                                            ${booking.paymentStatus}
                                        </span>
                                    </p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Total Price</label>
                                    <p class="form-control-plaintext">Rs. ${
                                      booking.totalPrice || "0.00"
                                    }</p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Notes</label>
                                    <p class="form-control-plaintext">${
                                      booking.notes || "No notes provided"
                                    }</p>
                                </div>
                            </div>
                        </div>
                    `;
            document.getElementById("viewBookingContent").innerHTML = content;
            new bootstrap.Modal(
              document.getElementById("viewBookingModal")
            ).show();
          })
          .catch((error) => {
            console.error("Error fetching booking:", error);
            alert("Error loading booking details");
          });
      }

      function selectService(serviceType) {
        document.getElementById("serviceType").value = serviceType;
        updateServicePrice();
        // Close services modal and open booking modal
        const servicesModal = bootstrap.Modal.getInstance(
          document.getElementById("servicesModal")
        );
        if (servicesModal) {
          servicesModal.hide();
        }
        const bookServiceModal = new bootstrap.Modal(
          document.getElementById("bookServiceModal")
        );
        bookServiceModal.show();
      }

      function editBooking(bookingId) {
        // Fetch booking data and populate the edit form
        fetch(`/customer/bookings/${bookingId}`)
          .then((response) => response.json())
          .then((booking) => {
            // Populate the form fields
            document.querySelector(
              '#editBookingForm input[name="vehicleNumber"]'
            ).value = booking.vehicleNumber || "";
            document.querySelector(
              '#editBookingForm select[name="serviceType"]'
            ).value = booking.serviceType || "";
            document.querySelector(
              '#editBookingForm input[name="bookingDate"]'
            ).value = booking.bookingDate
              ? booking.bookingDate.split("T")[0]
              : "";
            document.querySelector(
              '#editBookingForm select[name="paymentMethod"]'
            ).value = booking.paymentMethod || "";
            document.querySelector(
              '#editBookingForm input[name="servicePrice"]'
            ).value = booking.servicePrice || "";
            document.querySelector(
              '#editBookingForm input[name="additionalCharges"]'
            ).value = booking.additionalCharges || "";
            document.querySelector(
              '#editBookingForm textarea[name="notes"]'
            ).value = booking.notes || "";

            // Update the form action URL with the booking ID
            document.querySelector(
              "#editBookingForm"
            ).action = `/customer/bookings/${bookingId}/update`;

            // Show the modal
            const editModal = new bootstrap.Modal(
              document.getElementById("editBookingModal")
            );
            editModal.show();
          })
          .catch((error) => {
            console.error("Error fetching booking:", error);
            alert("Error loading booking details. Please try again.");
          });
      }

      function cancelBooking(bookingId) {
        if (confirm("Are you sure you want to cancel this booking?")) {
          // Implementation for canceling booking
          console.log("Cancel booking:", bookingId);
        }
      }

      function resetProfileForm() {
        if (confirm("Are you sure you want to reset all changes?")) {
          // Reload the page to reset the form
          location.reload();
        }
      }

      // Initialize tooltips and form validation
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Set minimum date to 2 days from today (if today is 28th, can only select from 30th)
        const bookingDateInput = document.getElementById("bookingDate");
        if (bookingDateInput) {
          const today = new Date();
          const minDate = new Date(today);
          minDate.setDate(today.getDate() + 2); // 2 days from today

          const minDateString = minDate.toISOString().split("T")[0];
          bookingDateInput.min = minDateString;

          // Add validation for date selection
          bookingDateInput.addEventListener("change", function () {
            const selectedDate = new Date(this.value);
            const today = new Date();
            const twoDaysFromNow = new Date(today);
            twoDaysFromNow.setDate(today.getDate() + 2);

            // Set time to start of day for accurate comparison
            twoDaysFromNow.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);

            if (selectedDate < twoDaysFromNow) {
              alert(
                "Please select a date at least 2 days in advance (if today is " +
                  today.getDate() +
                  ", you can only select from " +
                  twoDaysFromNow.getDate() +
                  " onwards)."
              );
              this.value = "";
              return;
            }

            // Load available slots when date is selected
            loadAvailableSlots();
          });
        }

        // Simple event listeners
        const serviceTypeSelect = document.getElementById("serviceType");
        if (serviceTypeSelect) {
          serviceTypeSelect.addEventListener("change", function () {
            updateServicePrice();
            // Load available slots when service type changes (if date is already selected)
            const dateInput = document.getElementById("bookingDate");
            if (dateInput && dateInput.value) {
              loadAvailableSlots();
            }
          });
        }


        // Simple payment validation
        function updatePaymentInfo() {
          const paymentMethod = document.getElementById("paymentMethod").value;
          const payingAmount = parseFloat(document.getElementById("payingAmount").value) || 0;
          
          if (paymentMethod && payingAmount > 0) {
            console.log('Payment info updated:', { paymentMethod, payingAmount });
          }
        }

        // Calculate processing fees using backend payment strategy
        function calculateProcessingFees(amount, paymentMethod, callback) {
          if (!paymentMethod || paymentMethod === "CASH" || amount <= 0) {
            callback(0);
            return;
          }

          // Make API call to get processing fees from backend
          fetch('/customer/payment/calculate-fees', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: `amount=${amount}&paymentMethod=${paymentMethod}`
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              callback(parseFloat(data.processingFees) || 0);
          } else {
            // No fallback - processing fees should come from backend
            callback(0);
          }
          })
          .catch(error => {
            // No fallback - processing fees should come from backend
            console.error('Error fetching processing fees:', error);
            callback(0);
          });
        }


        // Pay full amount function using backend API
        function payFullAmount() {
          const serviceType = document.getElementById("serviceType").value;
          
          if (!serviceType) {
            alert('Please select a service type first.');
            return;
          }
          
          // Show loading state
          const payFullBtn = document.getElementById("payFullAmountBtn");
          const originalText = payFullBtn.innerHTML;
          payFullBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calculating...';
          payFullBtn.disabled = true;
          
          // Call backend pricing API
          fetch('/customer/pricing/calculate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: `serviceType=${encodeURIComponent(serviceType)}`
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const price = parseFloat(data.basePrice) || 0;
              document.getElementById("payingAmount").value = price.toFixed(2);
              
              // Show success message
              payFullBtn.innerHTML = '<i class="fas fa-check me-1"></i>Amount Set!';
              payFullBtn.classList.remove('btn-outline-primary');
              payFullBtn.classList.add('btn-success');
              
              // Reset button after 2 seconds
              setTimeout(() => {
                payFullBtn.innerHTML = originalText;
                payFullBtn.classList.remove('btn-success');
                payFullBtn.classList.add('btn-outline-primary');
                payFullBtn.disabled = false;
              }, 2000);
            } else {
              alert('Error calculating price. Please try again.');
              payFullBtn.innerHTML = originalText;
              payFullBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error fetching pricing:', error);
            alert('Error calculating price. Please try again.');
            payFullBtn.innerHTML = originalText;
            payFullBtn.disabled = false;
          });
        }

        // Function to show helpful payment messages
        function showPaymentHelperMessage(message) {
          // Remove any existing helper messages
          const existingHelper = document.getElementById("paymentHelperMessage");
          if (existingHelper) {
            existingHelper.remove();
          }
          
          // Create new helper message
          const helperDiv = document.createElement("div");
          helperDiv.id = "paymentHelperMessage";
          helperDiv.className = "alert alert-info mt-2";
          helperDiv.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            <strong>Smart Payment:</strong> ${message}
            <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="payFullAmount()">
              <i class="fas fa-calculator me-1"></i>Pay Full Amount
            </button>
          `;
          
          // Insert after the paying amount field
          const payingAmountField = document.getElementById("payingAmount").closest('.col-md-6');
          payingAmountField.appendChild(helperDiv);
          
          // Auto-remove after 10 seconds
          setTimeout(() => {
            if (helperDiv.parentNode) {
              helperDiv.remove();
            }
          }, 10000);
        }

        function updatePaymentValidation(payingAmount, totalCost, paymentMethod) {
          const payingAmountInput = document.getElementById("payingAmount");
          const paymentMethodSelect = document.getElementById("paymentMethod");
          
          // Reset validation classes
          payingAmountInput.classList.remove("is-valid", "is-invalid");
          paymentMethodSelect.classList.remove("is-valid", "is-invalid");

          // Validate paying amount
          if (payingAmount > 0) {
            payingAmountInput.classList.add("is-valid");
            payingAmountInput.setCustomValidity("");
          } else {
            payingAmountInput.setCustomValidity("");
          }

          // Validate payment method
          if (paymentMethod) {
            paymentMethodSelect.classList.add("is-valid");
          } else {
            paymentMethodSelect.classList.add("is-invalid");
          }

          // Enable/disable payment button
          updatePaymentButton(payingAmount, totalCost, paymentMethod);
          
          // Show/hide payment warning
          const paymentWarning = document.getElementById("paymentWarning");
          if (payingAmount > 0 && totalCost > 0 && payingAmount < totalCost) {
            paymentWarning.style.display = "block";
          } else {
            paymentWarning.style.display = "none";
          }
        }



        function getBookingId() {
          // Try to get booking ID from various sources
          const urlParams = new URLSearchParams(window.location.search);
          const bookingId = urlParams.get('bookingId');
          if (bookingId) return bookingId;
          
          // Check if we're editing an existing booking
          const editForm = document.getElementById('editBookingForm');
          if (editForm) {
            const bookingIdInput = editForm.querySelector('input[name="id"]');
            if (bookingIdInput) return bookingIdInput.value;
          }
          
          return null;
        }

        function updateFormWithPaymentData(paymentData) {
          // Update the form with payment processing results
          const paidAmountInput = document.querySelector('input[name="paidAmount"]');
          if (paidAmountInput) {
            const currentPaid = parseFloat(paidAmountInput.value) || 0;
            paidAmountInput.value = (currentPaid + parseFloat(paymentData.amount)).toFixed(2);
          }
          
          // Update payment method in form
          const paymentMethodInput = document.querySelector('select[name="paymentMethod"]');
          if (paymentMethodInput) {
            paymentMethodInput.value = paymentData.paymentMethod || document.getElementById("paymentMethod").value;
          }
          
          // Trigger form update
          updatePaymentInfo();
        }

        // Initialize payment form on page load
        document.addEventListener('DOMContentLoaded', function() {
          // Initialize payment form with current values
          setTimeout(() => {
            updatePaymentInfo();
            updatePricingSummary();
          }, 100);
        });

        // Test function for Processing Fees (can be called from browser console)
        function testProcessingFees() {
          console.log('Testing Processing Fees calculation...');
          
          // Test Cash payment (should be 0)
          console.log('Cash payment test:');
          updatePaymentInfo();
          
          // Test Card payment
          const paymentMethodSelect = document.getElementById("paymentMethod");
          const payingAmountInput = document.getElementById("payingAmount");
          
          if (paymentMethodSelect && payingAmountInput) {
            const originalPaymentMethod = paymentMethodSelect.value;
            const originalPayingAmount = payingAmountInput.value;
            
            // Set to VISA and 1000 LKR
            paymentMethodSelect.value = "VISA";
            payingAmountInput.value = "1000";
            updatePaymentInfo();
            
            console.log('VISA payment test (1000 LKR):');
            console.log('Expected processing fees: 25.00 LKR (minimum)');
            
            // Reset to original values
            paymentMethodSelect.value = originalPaymentMethod;
            payingAmountInput.value = originalPayingAmount;
            updatePaymentInfo();
          }
        }

        // Add event listeners for form validation
        const bookingForm = document.querySelector(
          'form[th\\:action="@{/customer/bookings/save}"]'
        );
        if (bookingForm) {
          bookingForm.addEventListener("submit", function (e) {
            const timeSlot = document.getElementById("timeSlot").value;
            const date = document.getElementById("bookingDate").value;
            const paymentMethod =
              document.getElementById("paymentMethod").value;

            if (!timeSlot || !date) {
              e.preventDefault();
              alert("Please select both a date and time slot for the booking.");
              return false;
            }

            if (!paymentMethod) {
              e.preventDefault();
              alert("Please select a payment method.");
              return false;
            }

            // Validate payment amount
            const payingAmount = parseFloat(document.getElementById("payingAmount").value) || 0;
            
            if (payingAmount <= 0) {
              e.preventDefault();
              alert("Please enter a valid payment amount.");
              return false;
            }

            // Validate date is at least 2 days in advance
            const selectedDate = new Date(date);
            const today = new Date();
            const twoDaysFromNow = new Date(today);
            twoDaysFromNow.setDate(today.getDate() + 2);

            // Set time to start of day for accurate comparison
            twoDaysFromNow.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);

            if (selectedDate < twoDaysFromNow) {
              e.preventDefault();
              alert(
                "Please select a date at least 2 days in advance (if today is " +
                  today.getDate() +
                  ", you can only select from " +
                  twoDaysFromNow.getDate() +
                  " onwards)."
              );
              return false;
            }

            // Create datetime string for form submission
            const datetimeString = `${date}T${timeSlot}`;

            // Add hidden input for booking date
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "bookingDate";
            hiddenInput.value = datetimeString;
            this.appendChild(hiddenInput);
          });
        }

        // Add profile form validation
        const profileForm = document.getElementById("profileForm");
        if (profileForm) {
          profileForm.addEventListener("submit", function (e) {
            e.preventDefault();
            if (validateProfileForm()) {
              showFormLoading("profileForm");
              this.submit();
            }
          });

          // Add real-time validation for profile form fields
          const profileFields = profileForm.querySelectorAll("input, textarea");
          profileFields.forEach((field) => {
            field.addEventListener("blur", function () {
              validateField(this);
            });
            field.addEventListener("input", function () {
              if (this.classList.contains("is-invalid")) {
                validateField(this);
              }
            });
          });
        }

        // Add password form validation
        const passwordForm = document.getElementById("passwordForm");
        if (passwordForm) {
          passwordForm.addEventListener("submit", function (e) {
            e.preventDefault();
            if (validatePasswordForm()) {
              showFormLoading("passwordForm");
              this.submit();
            }
          });

          // Add real-time validation for password form fields
          const passwordFields = passwordForm.querySelectorAll("input");
          passwordFields.forEach((field) => {
            field.addEventListener("blur", function () {
              validateField(this);
            });
            field.addEventListener("input", function () {
              if (this.classList.contains("is-invalid")) {
                validateField(this);
              }
            });
          });

          // Add password confirmation validation
          const newPasswordField = document.getElementById("newPassword");
          const confirmPasswordField =
            document.getElementById("confirmPassword");
          if (newPasswordField && confirmPasswordField) {
            confirmPasswordField.addEventListener("input", function () {
              if (this.value && newPasswordField.value !== this.value) {
                showFieldError(this, "Passwords do not match");
              } else if (this.value && newPasswordField.value === this.value) {
                showFieldSuccess(this);
              }
            });
          }
        }
      });

      // Standardized validation system (matching other forms in the system)
      function validateField(field) {
        const value = field.value.trim();
        const type = field.type;
        const pattern = field.pattern;
        const minLength = field.minLength;
        const maxLength = field.maxLength;
        const min = field.min;
        const max = field.max;
        const fieldName = field.name;

        // Remove previous validation classes
        field.classList.remove("is-valid", "is-invalid");

        // Check required fields
        if (field.hasAttribute("required") && !value) {
          showFieldError(field, "This field is required");
          return false;
        }

        // Skip validation for empty optional fields
        if (!field.hasAttribute("required") && !value) {
          return true;
        }

        // Validate by type
        switch (type) {
          case "email":
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
              showFieldError(field, "Please enter a valid email address");
              return false;
            }
            break;

          case "tel":
            const phoneRegex = /^[\+]?[0-9\s\-\(\)]{7,20}$/;
            if (!phoneRegex.test(value)) {
              showFieldError(field, "Please enter a valid phone number");
              return false;
            }
            break;

          case "text":
            // Special validation for specific field types
            if (fieldName === "firstName" || fieldName === "lastName") {
              const nameRegex = /^[A-Za-z\s'-]{2,50}$/;
              if (!nameRegex.test(value)) {
                showFieldError(
                  field,
                  "Name must be 2-50 characters, letters, spaces, hyphens, and apostrophes only. Numbers and special characters are not allowed."
                );
                return false;
              }
              // Additional check to ensure no numbers
              if (/\d/.test(value)) {
                showFieldError(
                  field,
                  "Name cannot contain numbers. Please use only letters, spaces, hyphens, and apostrophes."
                );
                return false;
              }
            } else if (fieldName === "city" || fieldName === "state") {
              const cityStateRegex = /^[A-Za-z\s]+$/;
              if (!cityStateRegex.test(value)) {
                showFieldError(field, "Please enter only letters and spaces");
                return false;
              }
            } else if (fieldName === "zipCode") {
              const zipRegex = /^[A-Za-z0-9\s-]{3,10}$/;
              if (!zipRegex.test(value)) {
                showFieldError(field, "Please enter a valid ZIP/postal code");
                return false;
              }
            }
            break;

          case "password":
            if (value.length < 6) {
              showFieldError(
                field,
                "Password must be at least 6 characters long"
              );
              return false;
            }
            break;

          case "date":
            if (value) {
              const selectedDate = new Date(value);
              const today = new Date();
              if (selectedDate > today) {
                showFieldError(field, "Date of birth cannot be in the future");
                return false;
              }
            }
            break;
        }

        // Validate length
        if (minLength && minLength > 0 && value.length < minLength) {
          showFieldError(field, `Must be at least ${minLength} characters`);
          return false;
        }
        if (maxLength && maxLength > 0 && value.length > maxLength) {
          showFieldError(field, `Must not exceed ${maxLength} characters`);
          return false;
        }

        // Validate pattern
        if (pattern) {
          const regex = new RegExp(pattern);
          if (!regex.test(value)) {
            showFieldError(field, field.title || "Please enter a valid value");
            return false;
          }
        }

        // Show success state
        showFieldSuccess(field);
        return true;
      }

      function showFieldError(field, message) {
        field.classList.add("is-invalid");
        field.classList.remove("is-valid");

        // Remove existing error message
        const existingError =
          field.parentNode.querySelector(".invalid-feedback");
        if (existingError) {
          existingError.remove();
        }

        // Add new error message
        const errorDiv = document.createElement("div");
        errorDiv.className = "invalid-feedback";
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
      }

      function showFieldSuccess(field) {
        field.classList.add("is-valid");
        field.classList.remove("is-invalid");

        // Remove error message
        const existingError =
          field.parentNode.querySelector(".invalid-feedback");
        if (existingError) {
          existingError.remove();
        }
      }

      function validateProfileForm() {
        const form = document.getElementById("profileForm");
        const fields = form.querySelectorAll(
          "input[required], textarea[required]"
        );
        let isValid = true;

        fields.forEach((field) => {
          if (!validateField(field)) {
            isValid = false;
          }
        });

        return isValid;
      }

      function validatePasswordForm() {
        const form = document.getElementById("passwordForm");
        const fields = form.querySelectorAll("input[required]");
        let isValid = true;

        fields.forEach((field) => {
          if (!validateField(field)) {
            isValid = false;
          }
        });

        // Additional validation for password confirmation
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        if (newPassword !== confirmPassword) {
          const confirmField = document.getElementById("confirmPassword");
          showFieldError(confirmField, "Passwords do not match");
          isValid = false;
        }

        return isValid;
      }

      function showFormLoading(formId) {
        const form = document.getElementById(formId);
        const loadingDiv = form.querySelector(`#${formId}Loading`);
        const contentDiv = form.querySelector(`#${formId}Content`);

        if (loadingDiv && contentDiv) {
          contentDiv.classList.add("d-none");
          loadingDiv.classList.remove("d-none");
        }
      }

      function hideFormLoading(formId) {
        const form = document.getElementById(formId);
        const loadingDiv = form.querySelector(`#${formId}Loading`);
        const contentDiv = form.querySelector(`#${formId}Content`);

        if (loadingDiv && contentDiv) {
          loadingDiv.classList.add("d-none");
          contentDiv.classList.remove("d-none");
        }
      }

      // Update resetProfileForm function to work with new form structure
      function resetProfileForm() {
        if (confirm("Are you sure you want to reset all changes?")) {
          // Clear validation states
          const form = document.getElementById("profileForm");
          const fields = form.querySelectorAll("input, textarea");
          fields.forEach((field) => {
            field.classList.remove("is-valid", "is-invalid");
            const errorDiv =
              field.parentNode.querySelector(".invalid-feedback");
            if (errorDiv) {
              errorDiv.remove();
            }
          });

          // Reload the page to reset the form
          location.reload();
        }
      }

      // Add function to open password change modal
      function openPasswordModal() {
        const passwordModal = new bootstrap.Modal(
          document.getElementById("passwordModal")
        );
        passwordModal.show();
      }

      // Check if feedback exists and submit feedback
      function checkFeedbackAndSubmit(bookingId) {
        fetch(`/customer/bookings/${bookingId}/feedback/exists`)
          .then((response) => response.json())
          .then((data) => {
            if (data.exists) {
              alert("Feedback has already been submitted for this booking.");
            } else {
              window.location.href = `/customer/bookings/${bookingId}/feedback`;
            }
          })
          .catch((error) => {
            console.error("Error checking feedback:", error);
            // If there's an error, still allow navigation to feedback form
            window.location.href = `/customer/bookings/${bookingId}/feedback`;
          });
      }
    </script>

    <style>
      .btn-action {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .btn-action:hover {
        background-color: #f8f9fa;
        color: #495057;
      }

      .btn-action-success {
        color: #28a745;
      }

      .btn-action-success:hover {
        background-color: #d4edda;
        color: #155724;
      }

      .btn-group .btn-action {
        margin-right: 0.25rem;
      }

      .btn-group .btn-action:last-child {
        margin-right: 0;
      }
    </style>

    <!-- Edit Booking Modal -->
    <div
      class="modal fade"
      id="editBookingModal"
      tabindex="-1"
      aria-labelledby="editBookingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editBookingModalLabel">
              <i class="fas fa-edit me-2 text-primary"></i>Edit Booking
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form
            id="editBookingForm"
            th:action="@{/customer/bookings/{id}/update(id=${booking.id})}"
            th:object="${booking}"
            method="post"
          >
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-car me-2 text-primary"></i>Vehicle Number
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    th:field="*{vehicleNumber}"
                    placeholder="Enter vehicle number (e.g., ABC-1234)"
                    required
                    pattern="[A-Za-z]{3}-[0-9]{4}"
                    title="Please enter vehicle number in format ABC-1234 (3 letters, hyphen, 4 numbers)"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-wrench me-2 text-primary"></i>Service Type
                    <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    th:field="*{serviceType}"
                    required
                  >
                    <option value="">Select service type</option>
                    <!-- Basic Services -->
                    <option value="Oil Change">Oil Change</option>
                    <option value="Tire Service">Tire Service</option>
                    <option value="Air Filter Replacement">Air Filter Replacement</option>
                    <option value="Spark Plug Replacement">Spark Plug Replacement</option>
                    <option value="General Maintenance">General Maintenance</option>
                    <!-- Advanced Services -->
                    <option value="Engine Inspection">Engine Inspection</option>
                    <option value="Engine Repair">Engine Repair</option>
                    <option value="Transmission Service">Transmission Service</option>
                    <option value="Brake Service">Brake Service</option>
                    <option value="Electrical Service">Electrical Service</option>
                    <option value="AC Service">AC Service</option>
                    <option value="Major Overhaul">Major Overhaul</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-calendar me-2 text-primary"></i>Booking
                    Date
                    <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    class="form-control"
                    th:field="*{bookingDate}"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-credit-card me-2 text-primary"></i>Payment
                    Method
                    <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    th:field="*{paymentMethod}"
                    required
                  >
                    <option value="">Select payment method</option>
                    <option value="CASH">Cash</option>
                    <option value="CARD">Card</option>
                    <option value="UPI">UPI</option>
                    <option value="NET_BANKING">Net Banking</option>
                    <option value="WALLET">Wallet</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-dollar-sign me-2 text-primary"></i>Service
                    Price
                  </label>
                  <input
                    type="number"
                    class="form-control"
                    id="servicePrice"
                    th:field="*{servicePrice}"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    oninput="updatePaymentInfo()"
                    onchange="updatePaymentInfo()"
                    onkeyup="updatePaymentInfo()"
                    onpaste="setTimeout(updatePaymentInfo, 10)"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">
                    <i class="fas fa-plus me-2 text-primary"></i>Additional
                    Charges
                  </label>
                  <input
                    type="number"
                    class="form-control"
                    id="additionalCharges"
                    th:field="*{additionalCharges}"
                    step="0.01"
                    min="0"
                    placeholder="0.00"
                    oninput="updatePaymentInfo()"
                    onchange="updatePaymentInfo()"
                    onkeyup="updatePaymentInfo()"
                    onpaste="setTimeout(updatePaymentInfo, 10)"
                  />
                  <!-- Hidden field for total cost including processing fees -->
                  <input
                    type="hidden"
                    id="totalCost"
                    name="totalCost"
                    value="0.00"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">
                  <i class="fas fa-sticky-note me-2 text-primary"></i>Notes
                </label>
                <textarea
                  class="form-control"
                  th:field="*{notes}"
                  rows="3"
                  placeholder="Any additional notes or special requirements..."
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Update Booking
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
